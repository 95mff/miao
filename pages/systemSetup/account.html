<!DOCTYPE html>
<html>

	<head>

		<title>智慧校园管理平台</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="shortcut icon" type="images/x-icon" href="../../favicon.ico">
		<link href="../../css/bootstrap.min14ed.css?v=3.3.6" rel="stylesheet">
		<link href="../../css/font-awesome.min93e3.css?v=4.4.0" rel="stylesheet">
		<link href="../../css/animate.min.css" rel="stylesheet">
		<link href="../../css/style.min862f.css?v=4.1.0" rel="stylesheet">
		<link href="../../css/plugins/iCheck/custom.css" rel="stylesheet">
		<link rel="stylesheet" href="../../css/index_add.css" />
		<link rel="stylesheet" href="../../css/student.css" />
		<link href="../../css/myPagination.css" rel="stylesheet">
		<link href="../../css/iconfont_icon.css" rel="stylesheet">

	</head>

	<body class="gray-bg top-navigation">

		<div id="wrapper">
			<div id="page-wrapper" class="gray-bg">
				<div class="row border-bottom white-bg">
					<nav class="navbar navbar-static-top" role="navigation">
						<div class="nav_header">
							<div class="nav_header_top">
								<div class="nav_header_top_inner">
									<p style="float: left;">
										<img src="../../img/logo_content.png" alt="头像" title="头像" class="nav_header_tou" />
										<span class="logo_title">智慧校园运营管理系统</span>
									</p>
									<ul class="nav_list">
										<li>
											<a href="../../index.html"><i class="icon iconfont icon-yuangongguanli-copy"></i>员工管理</a>

										</li>
										<li>
											<a href="../studentAdministration/grade.html"><i class="icon iconfont icon-xueshengguanli"></i>学生管理</a>
											<ul class="nav_list_menu" style="margin-left:-160px;">
												<li>
													<a href="../studentAdministration/grade.html">年级管理</a>
												</li>
												<li>
													<a href="../studentAdministration/dorms.html">宿舍管理</a>
												</li>

											</ul>
										</li>
										<li>
											<a href="../visitorAdministration/stranger.html"><i class="icon iconfont icon-fangkeguanli"></i>来访管理</a>
											<ul class="nav_list_menu" style="margin-left:-260px;">
												<li>
													<a href="../visitorAdministration/stranger.html">陌生人员名单</a>
												</li>

												<li>
													<a href="../visitorAdministration/blacklist.html">黑名单</a>
												</li>
												<li>
													<a href="../visitorAdministration/whitelist.html">白名单</a>
												</li>
												<li>
													<a href="../visitorAdministration/exemptionAttendanceList.html">免考勤名单</a>
												</li>
											</ul>
										</li>
										<li>
											<a href="../kqAdministration/dayRule.html"><i class="icon iconfont icon-kaoqinguanli"></i>考勤管理</a>
											<ul class="nav_list_menu " style="margin-left:-400px;">
												<li>
													<a href="../kqAdministration/dayRule.html">日考勤规则</a>
												</li>
												<li>
													<a href="../kqAdministration/weekRule.html">周考勤规则</a>
												</li>
												<li>
													<a href="../kqAdministration/kq_group.html">考勤组管理</a>
												</li>
												<li>
													<a href="../kqAdministration/holiday.html">假期管理</a>
												</li>
												<li>
													<a href="../kqAdministration/pushTime.html">推送时间管理</a>
												</li>
												<li>
													<a href="../kqAdministration/jurisdiction.html">权限管理</a>
												</li>
											</ul>
										</li>
										<li>
											<a href="../kqCount/AttendanceStatistics.html"><i class="icon iconfont icon-tongji"></i>考勤统计</a>

										</li>

										<li class="nav_listActive">
											<a href="../systemSetup/account.html"><i class=" icon iconfont icon-xitongguanli-fuben"></i>系统设置</a>
											<ul class="nav_list_menu show" style="margin-left:-640px;">

												<li class="nav_list_menuActive">
													<a href="../systemSetup/account.html">账号管理</a>
												</li>
												<li>
													<a href="../systemSetup/schoolGate.html">监控门管理</a>
												</li>
												<li>
													<a href="../systemSetup/equipment.html">设备管理</a>
												</li>
												<li>
													<a href="../systemSetup/screen.html">大屏管理</a>
												</li>

											</ul>
										</li>
									</ul>
								</div>
								<p class="user">
									<span >欢迎您：<span class="userName">lcyz_admin</span></span>
									<a href="../../login.html" class="color"><i class="icon iconfont icon-tuichu"></i>退出登录</a>
								</p>
							</div>
						</div>

					</nav>
				</div>
				<div class="wrapper wrapper-content">
					<div class="container white-bg">
						<div class="row">
							<div class="col-md-12 content_title details_title">
								<h3 class="left m-t15">账号管理</h3>
								<button class="btn btn-sm btn-primary fontSize15" style="margin-top:10px;margin-left:10px;" onclick="addAccount()"><i class="fa fa-plus" ></i>新增账号</button>
							</div>
							<div class="col-md-12 m-t15 m-b10" style="margin-top:30px;">

								<form class="form-horizontal ">

									<div class="form-group col-md-5">

										<label class="col-sm-2 p-lNone control-label input_label" style="padding-top:0px;">账号名：</label>
										<div class="col-sm-10 p-lNone">
											<input id="accountName" name="accountName" minlength="2" type="text" class="laydate-icon form-control layer-date" placeholder="请输入账号名...">

										</div>

									</div>
									<div class="form-group col-md-5">

										<label class="col-sm-2 p-lNone control-label input_label" style="padding-top:0px;">角色：</label>
										<div class="col-sm-10 p-lNone">
											<select class="form-control " name="job" id="jobSelect" required="" aria-required="true">
												<option value="">请选择角色...</option>
												<option value="houseparent">宿管</option>
												<option value="guard">门卫</option>
												<option value="student">家长</option>
												<option value="teacher">教职工</option>
												<option value="mananger">系统管理员</option>

											</select>

										</div>

									</div>

									<div class="form-group col-md-1">

										<a href="#" class="btn btn-primary" onclick="searchAccount()">查询</a>
									</div>

								</form>
							</div>
							<div class="row">

								<!--右侧-->
								<div class="col-lg-12">

									<!--list-->
									<div class="row">

										<div class="col-md-12 m-t10">

											<div class="ibox float-e-margins ">

												<div class="ibox-content pnone">

													<div class="table-responsive relative">
														<table class="table table-striped" id="accountNumTable">
															<thead>
																<tr>
																	<th>账号名</th>
																	<th>角色</th>
																	<th>权限</th>
																	<th style="text-align: center;">操作</th>

																</tr>
															</thead>
															<tbody>

															</tbody>
														</table>

													</div>
													<!--分页-->
													<div id="pagination" class="pagination"></div>
												</div>
											</div>

										</div>
									</div>

								</div>

							</div>

						</div>

					</div>
				</div>

				<script src="../../js/jquery.min.js?v=2.1.4"></script>
				<script src="../../js/bootstrap.min.js?v=3.3.6"></script>
				<script src="../../js/content.min.js?v=1.0.0"></script>
				<script src="../../js/plugins/layer/layer.min.js"></script>
				<script src="../../js/myPagination.js"></script>

				<script src="../../js/common.js"></script>
				<script src="../../js/script/config.js"></script>

	</body>
	<script>
		var token = sessionStorage.getItem("user_token");
		$(document).ready(function() {
			allList();
		});
		var pageSize = 10;
		var pageNum = 1;
		var accountName = $('#accountName').val();
		var jobName = $('#jobSelect option:selected').val();
		//获取全部账号
		function allList() {
			var index = layer.msg('加载中', {
				icon: 16,
				time: 0

			});
			$.ajax({
				type: "post",
				url: http + "account/findAllLoginUser",
				contentType: "application/json;charset=utf-8",
				dataType: "json",
				data: JSON.stringify({
					"pageSize": pageSize,
					"pageNumber": pageNum,
					"userName": accountName,
					"classification": jobName
				}),
				beforeSend: function(XMLHttpRequest) {
					XMLHttpRequest.setRequestHeader("user_token", token);
				},
				success: function(data) {
					layer.close(index);
					if(data.success == false) {
						layer.msg(data.msg);
						return false;
					}
					if(data.success) {
						console.log(data)
						userToken(data.restCode, data.msg);
						if(data.restCode == 200) {
							var list = data.obj.list;
							if(!jQuery.isEmptyObject(list)) {
								$('#accountNumTable tbody').html("");
								$('#pagination').show();
								var item = "";
								for(var i = 0; i < list.length; i++) {
									item += '<tr data-id="' + list[i].id + '" data-type="' + list[i].classification + '">';
									item += '<td>' + list[i].loginName + '</td>';
									item += '<td>' + list[i].roleFlag + '</td>';
									item += '<td>' + list[i].gateName + '</td>';
									item += '<td style="text-align: center;">';
									item += '<button class="btn btn-sm btn-primary btn-del" onclick="dissolveRelationship(this)" >解除关系</button>';

									item += '<button class="btn btn-sm btn-primary btn-del" onclick="resetPwd(this)" >重置密码</button>';

									item += '<button class="btn btn-sm btn-primary btn-del" onclick="delAccount(this)" >删除</button>';
									item += '</td>';
									item += '</tr>';
								}
								$('#accountNumTable tbody').append(item);
								new myPagination({
									id: 'pagination',
									curPage: data.obj.pageNum, //初始页码
									pageTotal: data.obj.pages, //总页数
									pageAmount: data.obj.pageSize, //每页多少条
									dataTotal: data.obj.total, //总共多少条数据
									pageSize: 5, //可选,分页个数
									showPageTotalFlag: true, //是否显示数据统计
									showSkipInputFlag: false, //是否支持跳转
									getPage: function(page) {
										//获取当前页
										pageNum = page;
										allList();
									}
								})

							} else {
								$('#pagination').hide();
								$('#accountNumTable tbody').html('');
								item = '<tr><th colspan="4" style="text-align: center;">暂无数据</th></tr>';
								$('#accountNumTable tbody').append(item);
							}

						}
					}
				},
				error: function(error) {
					layer.close(index);
					layer.msg("程序错误,请重试！");
				}

			})
		}
		//删除账号
		function delAccount(elem) {
			var delId = $(elem).parent().parent().attr("data-id");
			$.ajax({
				type: "post",
				url: http + "account/checkLoginAccountNumber?id=" + delId,
				contentType: "application/json;charset=utf-8",
				dataType: "json",
				beforeSend: function(XMLHttpRequest) {
					XMLHttpRequest.setRequestHeader("user_token", token);
				},

				success: function(data) {
					console.log(data)
					if(data.success == false) {
						layer.alert('删除提示', {
							icon: 2,
							time: 0,
							content: "您确定要删除此账号吗？",
							title: '删除确认',
							btn: ['确定', '取消'],
							yes: function(index) {
								layer.close(index);
								var load = layer.load();
								del(delId, load);
							}
						});
					}
					if(data.success) {
						layer.alert('删除提示', {
							icon: 2,
							time: 0,
							content: data.msg,
							title: '删除确认',
							btn: ['确定', '取消'],
							yes: function(index) {
								layer.close(index);
								var load = layer.load();
								del(delId, load);
							}
						});
					}

				},
				error: function(error) {

					layer.msg("程序错误,请重试！");
				}
			});

		}
		//删除账号接口
		function del(delId, load) {
			$.ajax({
				type: "post",
				url: http + "account/deleteControlDoor?id=" + delId,
				contentType: "application/json;charset=utf-8",
				dataType: "json",
				beforeSend: function(XMLHttpRequest) {
					XMLHttpRequest.setRequestHeader("user_token", token);
				},

				success: function(data) {
					layer.close(load);
					if(data.success == false) {
						layer.msg(data.msg);
					}
					if(data.success) {
						layer.msg('删除账号成功', {
							time: 2000
						}, function() {
							allList();
						});

					}

				},
				error: function(error) {
					layer.close(load);
					layer.msg("程序错误,请重试！");
				}
			});
		}
		//新增账号
		function addAccount() {
			layer.open({
				title: '新增账号',
				type: 2,
				area: ['800px', '600px'],
				fixed: false, //不固定
				maxmin: true,
				btn: ['确定', '取消'],
				content: '../../pages/iframe/system/addAccountNumber.html',
				yes: function(guanbi, index) {
					var iframe = window[index.find('iframe')[0]['name']];
					//获取子界面传过来的参数
					iframe.addAccountSubmit()

				}
			});
		}
		//搜索账号
		function searchAccount() {
			pageNumber = 1;
			accountName = $('#accountName').val();
			jobName = $('#jobSelect option:selected').val();
			allList();
		}
		//重置密码
		function resetPwd(elem) {
			var id = $(elem).parent().parent().attr('data-id');
			layer.alert('是否重置密码', {
				icon: 1,
				time: 0,
				content: '您是否要重置密码？',
				title: '重置确定',
				btn: ['确定', '取消'],
				yes: function(index, layero) {
					layer.close(index);
					var load = layer.load();
					$.ajax({
						type: "post",
						url: http + "account/resetPassWord?id=" + id,
						contentType: "application/json;charset=utf-8",
						dataType: "json",
						beforeSend: function(XMLHttpRequest) {
							XMLHttpRequest.setRequestHeader("user_token", token);
						},
						success: function(data) {
							layer.close(load);
							console.log(data);
							if(data.success == false) {
								layer.msg(data.msg);
							}
							if(data.success) {
								layer.msg('重置密码成功', {
									time: 2000
								}, function() {
									allList();
								});

							}
						},
						error: function(error) {
							layer.close(load);
							layer.msg("程序错误,请重试！");
						}
					});
				}
			});
		}
		//解除关系
		var dissolveId = '';
		var obj = '';

		function dissolveRelationship(elem) {
			dissolveId = $(elem).parent().parent().attr('data-id');
			var accountType = $(elem).parent().parent().attr('data-type');
			if(accountType == "student") {
				var userId = [];
				$.ajax({
					type: "post",
					url: http + "account/findRelation?loginId=" + dissolveId,
					contentType: "application/json;charset=utf-8",
					dataType: "json",
					beforeSend: function(XMLHttpRequest) {
						XMLHttpRequest.setRequestHeader("user_token", token);
					},
					success: function(data) {
						console.log(data);
						if(data.success == false) {
							layer.msg(data.msg);
						}
						if(data.success) {
							obj = data.obj;
							if(data.restCode == 200) {
								if(!jQuery.isEmptyObject(obj)) {
									if(obj.length <= 1) {
										layer.alert('是否要解除关系？', {
											icon: 2,
											time: 0,
											content: '您确定要与' + obj[0].name + '解除账号关系吗？',
											title: '解除关系确定',
											btn: ['确定', '取消'],
											yes: function(index, layero) {
												layer.close(index);
												var load = layer.load();
												userId.push(obj[0].userId);
												$.ajax({
													type: "post",
													url: http + "account/removeRelation?loginId=" + dissolveId,
													contentType: "application/json;charset=utf-8",
													dataType: "json",
													data: JSON.stringify({
														"userId": userId
													}),
													beforeSend: function(XMLHttpRequest) {
														XMLHttpRequest.setRequestHeader("user_token", token);
													},
													success: function(data) {
														layer.close(load);
														console.log(data);
														if(data.success == false) {
															layer.msg(data.msg);
														}
														if(data.success) {
															layer.msg('解除关系成功', {
																time: 2000
															}, function() {
																allList();
															});

														}
													},
													error: function(error) {
														layer.close(load);
														layer.msg("程序错误,请重试！");
													}
												});
											}
										});
									} else {
										layer.open({
											title: '解除关系',
											type: 2,
											area: ['340px', '240px'],
											fixed: false, //不固定
											maxmin: true,
											btn: ['确定', '取消'],
											content: '../../pages/iframe/system/dissolve.html',
											yes: function(guanbi, index) {
												var iframe = window[index.find('iframe')[0]['name']];
												//获取子界面传过来的参数
												iframe.dissolveAccountSubmit();

											}
										});
									}
								}else {
									layer.msg('此账号下暂无关系！');
									return false;
								}
							} 

						}
					},
					error: function(error) {
						layer.msg("程序错误,请重试！");
					}
				});
			} else {
				layer.msg('此账号暂不可解除关系！');
				return false;
			}

		}
	</script>

</html>